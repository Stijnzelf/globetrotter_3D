<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wereldreiziger 3D</title>
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/earth-planet.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000011">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/globe.gl@2.30.0/dist/globe.gl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; font-family: 'Fredoka', sans-serif; background-color: #000011; color: white; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; height: 100vh; width: 100vw; }
        #globeViz { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; touch-action: none; }
        .ui-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .interactive { pointer-events: auto; }
        .safe-top { padding-top: env(safe-area-inset-top, 20px); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .bounce { animation: bounce 1s infinite; }
        @keyframes pulse-fire { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .fire-anim { animation: pulse-fire 0.8s infinite; display: inline-block; }
        .glass-panel { background: rgba(20, 20, 40, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
    </style>
</head>
<body>

    <div id="globeViz"></div>

    <div class="ui-overlay">
        <!-- HEADER -->
        <div class="w-full px-4 pt-4 safe-top flex justify-center interactive">
            <div class="glass-panel w-full max-w-lg px-4 py-2 rounded-2xl flex justify-between items-center shadow-lg">
                <div class="flex flex-col leading-tight">
                    <span class="text-[10px] text-blue-200 font-bold uppercase tracking-wider">Ronde</span>
                    <span class="text-xl font-black text-blue-400"><span id="roundDisplay">1</span> / 10</span>
                </div>
                
                <div id="streakBadge" class="hidden flex items-center gap-1 text-orange-400 font-bold bg-orange-900/40 px-3 py-1 rounded-full border border-orange-500/30">
                    <span class="fire-anim">üî•</span> <span id="streakCount">3</span>
                </div>

                <div class="bg-yellow-500/20 border border-yellow-500/50 px-4 py-1 rounded-full flex items-center gap-2">
                    <span class="text-xl">‚≠ê</span>
                    <span id="scoreDisplay" class="font-bold text-yellow-400 text-lg">0</span>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="w-full px-4 pb-4 flex justify-center items-end interactive min-h-[150px]">
            <!-- VRAAG -->
            <div id="questionCard" class="bg-white/95 text-gray-900 rounded-3xl p-4 shadow-[0_0_50px_rgba(0,0,0,0.5)] border-4 border-blue-500 w-full max-w-md text-center hidden slide-up">
                <div class="flex items-center justify-between gap-3">
                    <div id="flagContainer" class="bg-gray-100 rounded-xl p-2 min-w-[70px] flex items-center justify-center shadow-inner">
                        <span id="targetFlag" class="text-5xl block leading-none">üá≥üá±</span>
                    </div>
                    <div class="text-left flex-grow flex flex-col justify-center overflow-hidden">
                        <p id="instructionLabel" class="text-gray-400 uppercase text-[10px] font-bold tracking-widest mb-1 truncate">Zoek dit land:</p>
                        <h2 id="targetName" class="text-2xl font-black text-gray-800 leading-none mb-1 truncate">Nederland</h2>
                        <div id="capitalWrapper">
                            <span id="capitalLabel" class="text-blue-500 text-xs font-bold">Hoofdstad: </span>
                            <span id="targetCapital" class="text-blue-700 text-sm font-bold truncate">Amsterdam</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTAAT -->
            <div id="resultBar" class="w-full max-w-md hidden slide-up">
                <div id="resultContent" class="bg-white text-gray-900 rounded-3xl shadow-2xl p-4 border-b-8 border-gray-300 flex items-center justify-between gap-4">
                    <div class="text-left flex-grow overflow-hidden">
                        <h3 id="resultTitle" class="text-xl font-black mb-1 truncate">Titel</h3>
                        <p id="resultSub" class="text-sm font-medium opacity-80 leading-tight">Subtekst</p>
                    </div>
                    <button id="nextBtn" class="bg-gray-900 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition active:scale-95 whitespace-nowrap">
                        Verder ‚û°Ô∏è
                    </button>
                </div>
            </div>

            <div id="loadingMsg" class="bg-black/50 px-6 py-3 rounded-full backdrop-blur text-white font-bold mb-10">
                üåé Wereldbol laden...
            </div>
        </div>
    </div>

    <!-- START SCHERM -->
    <div id="startScreen" class="interactive absolute inset-0 z-50 bg-[#000011] flex flex-col items-center justify-center text-white p-4 transition-all duration-500 overflow-y-auto">
        <div class="relative z-10 w-full max-w-md flex flex-col items-center">
            
            <div class="mt-4 mb-6 text-center">
                <div class="bg-white/10 p-4 rounded-full mb-2 backdrop-blur-md inline-block shadow-[0_0_30px_rgba(59,130,246,0.3)]">
                    <span class="text-5xl block">üöÄ</span>
                </div>
                <h1 class="text-4xl font-black mb-1 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400 drop-shadow-sm">Wereldreiziger</h1>
            </div>

            <!-- MODE SELECTIE -->
            <div id="modeSelection" class="w-full space-y-2 mb-6">
                <p class="text-center font-bold text-blue-200 mb-2 text-sm">WAT WIL JE OEFENEN?</p>
                <button id="btnClassic" class="w-full bg-gray-800/80 hover:bg-gray-700 border border-white/10 p-3 rounded-xl flex items-center gap-4 transition active:scale-95 group">
                    <span class="text-2xl">üåç</span> <div class="text-left"><div class="font-bold text-white">Landen</div><div class="text-[10px] text-gray-400 font-bold uppercase">Naam + Vlag</div></div>
                </button>
                <button id="btnFlags" class="w-full bg-gray-800/80 hover:bg-gray-700 border border-white/10 p-3 rounded-xl flex items-center gap-4 transition active:scale-95 group">
                    <span class="text-2xl">üè≥Ô∏è</span> <div class="text-left"><div class="font-bold text-white">Vlaggen</div><div class="text-[10px] text-gray-400 font-bold uppercase">Alleen Vlag</div></div>
                </button>
                <button id="btnCapitals" class="w-full bg-gray-800/80 hover:bg-gray-700 border border-white/10 p-3 rounded-xl flex items-center gap-4 transition active:scale-95 group">
                    <span class="text-2xl">üèõÔ∏è</span> <div class="text-left"><div class="font-bold text-white">Hoofdsteden</div><div class="text-[10px] text-gray-400 font-bold uppercase">Alleen Stad</div></div>
                </button>
            </div>

            <!-- LEVEL SELECTIE -->
            <div id="difficultySelection" class="w-full space-y-2 hidden mb-6">
                <p class="text-center font-bold text-blue-200 mb-2 text-sm">KIES JE NIVEAU</p>
                <button id="btnEasy" class="w-full bg-gradient-to-r from-green-900 to-green-800 border-l-4 border-green-500 p-3 rounded-r-xl text-left transition active:scale-95"><div class="flex justify-between items-center"><div><div class="font-bold text-green-100">Makkelijk</div><div class="text-[10px] text-green-300 font-bold">Grote landen</div></div><div class="text-lg font-black text-green-200/50">10pt</div></div></button>
                <button id="btnMedium" class="w-full bg-gradient-to-r from-yellow-900 to-yellow-800 border-l-4 border-yellow-500 p-3 rounded-r-xl text-left transition active:scale-95"><div class="flex justify-between items-center"><div><div class="font-bold text-yellow-100">Medium</div><div class="text-[10px] text-yellow-300 font-bold">Ook kleinere landen</div></div><div class="text-lg font-black text-yellow-200/50">12pt</div></div></button>
                <button id="btnHard" class="w-full bg-gradient-to-r from-red-900 to-red-800 border-l-4 border-red-500 p-3 rounded-r-xl text-left transition active:scale-95"><div class="flex justify-between items-center"><div><div class="font-bold text-red-100">Moeilijk</div><div class="text-[10px] text-red-300 font-bold">Voor experts</div></div><div class="text-lg font-black text-red-200/50">15pt</div></div></button>
                <button id="btnExam" class="w-full bg-gradient-to-r from-purple-900 to-purple-800 border-l-4 border-purple-500 p-3 rounded-r-xl text-left transition active:scale-95"><div class="flex justify-between items-center"><div><div class="font-bold text-purple-100">Examen</div><div class="text-[10px] text-purple-300 font-bold">Alles door elkaar</div></div><div class="text-lg font-black text-purple-200/50">15pt</div></div></button>
                <button id="btnBack" class="w-full text-gray-400 text-xs font-bold mt-2 hover:text-white">‚¨ÖÔ∏è Terug</button>
            </div>

            <!-- LEADERBOARD -->
            <div class="w-full bg-black/40 rounded-2xl p-4 border border-white/5">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-yellow-500 uppercase tracking-widest">üèÜ Top Scores</span>
                    <span id="scoreSourceBadge" class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-gray-400">Laden...</span>
                </div>
                <div id="leaderboardList" class="space-y-2 text-sm min-h-[100px]">
                    <div class="text-center text-gray-500 text-xs py-4">Gegevens ophalen...</div>
                </div>
            </div>

            <div class="mt-8 pb-8 text-center w-full flex flex-col items-center gap-4">
                <!-- 
                     LINK NAAR JE BUY ME A COFFEE PROFIEL
                -->
                <a href="https://buymeacoffee.com/stijnz11" target="_blank" rel="noopener noreferrer" class="group relative inline-flex items-center gap-2 px-5 py-2.5 bg-[#FFDD00] hover:bg-[#FFEA00] text-black font-black rounded-full shadow-[0_0_15px_rgba(255,221,0,0.3)] hover:shadow-[0_0_20px_rgba(255,221,0,0.6)] transition-all transform hover:-translate-y-1 active:translate-y-0 text-xs">
                    <span class="text-base">‚òï</span>
                    <span>Trakteer op koffie (Donatie)</span>
                </a>

                <a href="https://www.linkedin.com/in/stijnschretlen?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=ios_app" target="_blank" rel="noopener noreferrer" class="text-blue-300/50 text-[10px] hover:text-blue-300 transition">
                    created by <span class="font-bold border-b border-blue-300/30 pb-0.5">Stijnz11</span>
                </a>
            </div>
        </div>
    </div>

    <!-- EIND SCHERM -->
    <div id="endScreen" class="interactive absolute inset-0 z-50 bg-purple-900 flex flex-col items-center justify-center text-white p-4 hidden">
        <span class="text-8xl mb-4 bounce">üèÜ</span>
        <h1 class="text-4xl font-black mb-2">Klaar!</h1>
        
        <div class="glass-panel rounded-3xl p-6 w-full max-w-sm mb-6 text-center">
            <div class="text-sm uppercase font-bold text-purple-200 mb-2">Eindscore</div>
            <div class="text-6xl font-black text-yellow-400 mb-2" id="finalScore">0</div>
            <div class="text-lg font-bold opacity-80 mb-4" id="finalCorrectCount">0 / 10</div>
            
            <!-- HIGH SCORE INPUT -->
            <div id="highScoreInputArea" class="hidden mt-4 pt-4 border-t border-white/20">
                <p class="text-yellow-300 font-bold mb-2 animate-pulse">üéâ NIEUWE TOP SCORE!</p>
                <input type="text" id="playerNameInput" placeholder="Jouw naam" class="w-full text-center text-black font-bold p-3 rounded-xl mb-2 focus:outline-none focus:ring-4 focus:ring-yellow-400" maxlength="12">
                <button id="btnSaveScore" class="w-full bg-yellow-400 hover:bg-yellow-300 text-yellow-900 font-bold py-2 rounded-xl">Opslaan</button>
            </div>
        </div>

        <button id="restartBtn" class="bg-white text-purple-900 text-xl font-bold py-4 px-12 rounded-full shadow-[0_0_20px_rgba(255,255,255,0.4)] hover:scale-105 transition">
            Nog een keer üîÑ
        </button>
    </div>

    <!-- FIREBASE MODULE SCRIPT -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        window.firebaseAvailable = false;
        
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-id';
                
                await signInAnonymously(auth);
                window.firebaseAvailable = true;
                
                window.saveScoreCloud = async (name, score) => {
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), {
                            name: name, score: score, date: new Date().toISOString()
                        });
                        return true;
                    } catch(e) { console.error(e); return false; }
                };

                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'));
                
                // Error callback toegevoegd voor robuustheid
                onSnapshot(q, (snapshot) => {
                    let scores = [];
                    snapshot.forEach(doc => scores.push(doc.data()));
                    scores.sort((a, b) => b.score - a.score);
                    if(window.updateLeaderboardUI) window.updateLeaderboardUI(scores.slice(0, 10), true);
                }, (error) => {
                    console.warn("Firestore error, switching to offline mode:", error);
                    window.firebaseAvailable = false;
                    if(window.renderLeaderboardLocal) window.renderLeaderboardLocal();
                });
            }
        } catch (e) {
            console.log("Offline modus actief");
        }
    </script>

    <!-- GAME LOGIC SCRIPT -->
    <script>
        // --- DATA WITH 2-LETTER CODES FOR IMAGES ---
        const COUNTRIES = [
            // TIER 1
            { id: 'nl', t:1, iso:"NLD", n:"Nederland", c:"Amsterdam", lat: 52.13, lng: 5.29 },
            { id: 'be', t:1, iso:"BEL", n:"Belgi√´", c:"Brussel", lat: 50.50, lng: 4.46 },
            { id: 'de', t:1, iso:"DEU", n:"Duitsland", c:"Berlijn", lat: 51.16, lng: 10.45 },
            { id: 'fr', t:1, iso:"FRA", n:"Frankrijk", c:"Parijs", lat: 46.22, lng: 2.21 },
            { id: 'gb', t:1, iso:"GBR", n:"Ver. Koninkrijk", c:"Londen", lat: 55.37, lng: -3.43 },
            { id: 'es', t:1, iso:"ESP", n:"Spanje", c:"Madrid", lat: 40.46, lng: -3.74 },
            { id: 'it', t:1, iso:"ITA", n:"Itali√´", c:"Rome", lat: 41.87, lng: 12.56 },
            { id: 'us', t:1, iso:"USA", n:"Verenigde Staten", c:"Washington D.C.", lat: 37.09, lng: -95.71 },
            { id: 'ca', t:1, iso:"CAN", n:"Canada", c:"Ottawa", lat: 56.13, lng: -106.34 },
            { id: 'br', t:1, iso:"BRA", n:"Brazili√´", c:"Brasilia", lat: -14.23, lng: -51.92 },
            { id: 'cn', t:1, iso:"CHN", n:"China", c:"Beijing", lat: 35.86, lng: 104.19 },
            { id: 'jp', t:1, iso:"JPN", n:"Japan", c:"Tokio", lat: 36.20, lng: 138.25 },
            { id: 'au', t:1, iso:"AUS", n:"Australi√´", c:"Canberra", lat: -25.27, lng: 133.77 },
            { id: 'ru', t:1, iso:"RUS", n:"Rusland", c:"Moskou", lat: 61.52, lng: 105.31 },
            { id: 'in', t:1, iso:"IND", n:"India", c:"New Delhi", lat: 20.59, lng: 78.96 },
            { id: 'tr', t:1, iso:"TUR", n:"Turkije", c:"Ankara", lat: 38.96, lng: 35.24 },
            { id: 'eg', t:1, iso:"EGY", n:"Egypte", c:"Ca√Øro", lat: 26.82, lng: 30.80 },
            { id: 'za', t:1, iso:"ZAF", n:"Zuid-Afrika", c:"Pretoria", lat: -30.55, lng: 22.93 },
            { id: 'ma', t:1, iso:"MAR", n:"Marokko", c:"Rabat", lat: 31.79, lng: -7.09 },
            { id: 'gr', t:1, iso:"GRC", n:"Griekenland", c:"Athene", lat: 39.07, lng: 21.82 },
            { id: 'ar', t:1, iso:"ARG", n:"Argentini√´", c:"Buenos Aires", lat: -38.41, lng: -63.61 },
            { id: 'mx', t:1, iso:"MEX", n:"Mexico", c:"Mexico-Stad", lat: 23.63, lng: -102.55 },
            // TIER 2
            { id: 'pl', t:2, iso:"POL", n:"Polen", c:"Warschau", lat: 51.91, lng: 19.14 },
            { id: 'se', t:2, iso:"SWE", n:"Zweden", c:"Stockholm", lat: 60.12, lng: 18.64 },
            { id: 'no', t:2, iso:"NOR", n:"Noorwegen", c:"Oslo", lat: 60.47, lng: 8.46 },
            { id: 'fi', t:2, iso:"FIN", n:"Finland", c:"Helsinki", lat: 61.92, lng: 25.74 },
            { id: 'ua', t:2, iso:"UKR", n:"Oekra√Øne", c:"Kiev", lat: 48.37, lng: 31.16 },
            { id: 'pt', t:2, iso:"PRT", n:"Portugal", c:"Lissabon", lat: 39.39, lng: -8.22 },
            { id: 'ie', t:2, iso:"IRL", n:"Ierland", c:"Dublin", lat: 53.14, lng: -7.69 },
            { id: 'co', t:2, iso:"COL", n:"Colombia", c:"Bogota", lat: 4.57, lng: -74.29 },
            { id: 'pe', t:2, iso:"PER", n:"Peru", c:"Lima", lat: -9.19, lng: -75.01 },
            { id: 'cl', t:2, iso:"CHL", n:"Chili", c:"Santiago", lat: -35.67, lng: -71.54 },
            { id: 've', t:2, iso:"VEN", n:"Venezuela", c:"Caracas", lat: 6.42, lng: -66.58 },
            { id: 'sa', t:2, iso:"SAU", n:"Saoedi-Arabi√´", c:"Riyad", lat: 23.88, lng: 45.07 },
            { id: 'ir', t:2, iso:"IRN", n:"Iran", c:"Teheran", lat: 32.42, lng: 53.68 },
            { id: 'th', t:2, iso:"THA", n:"Thailand", c:"Bangkok", lat: 15.87, lng: 100.99 },
            { id: 'vn', t:2, iso:"VNM", n:"Vietnam", c:"Hanoi", lat: 14.05, lng: 108.27 },
            { id: 'id', t:2, iso:"IDN", n:"Indonesi√´", c:"Jakarta", lat: -0.78, lng: 113.92 },
            { id: 'kr', t:2, iso:"KOR", n:"Zuid-Korea", c:"Seoul", lat: 35.90, lng: 127.76 },
            { id: 'nz', t:2, iso:"NZL", n:"Nieuw-Zeeland", c:"Wellington", lat: -40.90, lng: 174.88 },
            { id: 'ng', t:2, iso:"NGA", n:"Nigeria", c:"Abuja", lat: 9.08, lng: 8.67 },
            { id: 'ke', t:2, iso:"KEN", n:"Kenia", c:"Nairobi", lat: -0.02, lng: 37.90 },
            { id: 'dz', t:2, iso:"DZA", n:"Algerije", c:"Algiers", lat: 28.03, lng: 1.65 },
            { id: 'at', t:2, iso:"AUT", n:"Oostenrijk", c:"Wenen", lat: 47.51, lng: 14.55 },
            { id: 'ch', t:2, iso:"CHE", n:"Zwitserland", c:"Bern", lat: 46.81, lng: 8.22 },
            { id: 'hu', t:2, iso:"HUN", n:"Hongarije", c:"Boedapest", lat: 47.16, lng: 19.50 },
            { id: 'cz', t:2, iso:"CZE", n:"Tsjechi√´", c:"Praag", lat: 49.81, lng: 15.47 },
            { id: 'dk', t:2, iso:"DNK", n:"Denemarken", c:"Kopenhagen", lat: 56.26, lng: 9.50 },
            { id: 'bg', t:2, iso:"BGR", n:"Bulgarije", c:"Sofia", lat: 42.73, lng: 25.48 },
            { id: 'bo', t:2, iso:"BOL", n:"Bolivia", c:"Sucre", lat: -16.29, lng: -63.58 },
            { id: 'pk', t:2, iso:"PAK", n:"Pakistan", c:"Islamabad", lat: 30.37, lng: 69.34 },
            { id: 'bd', t:2, iso:"BGD", n:"Bangladesh", c:"Dhaka", lat: 23.68, lng: 90.35 },
            { id: 'et', t:2, iso:"ETH", n:"Ethiopi√´", c:"Addis Abeba", lat: 9.14, lng: 40.48 },
            { id: 'gh', t:2, iso:"GHA", n:"Ghana", c:"Accra", lat: 7.94, lng: -1.02 },
            // TIER 3
            { id: 'is', t:3, iso:"ISL", n:"IJsland", c:"Reykjavik", lat: 64.96, lng: -19.02 },
            { id: 'hr', t:3, iso:"HRV", n:"Kroati√´", c:"Zagreb", lat: 45.10, lng: 15.20 },
            { id: 'kz', t:3, iso:"KAZ", n:"Kazachstan", c:"Astana", lat: 48.01, lng: 66.92 },
            { id: 'mn', t:3, iso:"MNG", n:"Mongoli√´", c:"Ulaanbaatar", lat: 46.86, lng: 103.84 },
            { id: 'np', t:3, iso:"NPL", n:"Nepal", c:"Kathmandu", lat: 28.39, lng: 84.12 },
            { id: 'ph', t:3, iso:"PHL", n:"Filipijnen", c:"Manilla", lat: 12.87, lng: 121.77 },
            { id: 'my', t:3, iso:"MYS", n:"Maleisi√´", c:"Kuala Lumpur", lat: 4.21, lng: 101.97 },
            { id: 'lk', t:3, iso:"LKA", n:"Sri Lanka", c:"Colombo", lat: 7.87, lng: 80.77 },
            { id: 'mg', t:3, iso:"MDG", n:"Madagaskar", c:"Antananarivo", lat: -18.76, lng: 46.86 },
            { id: 'tz', t:3, iso:"TZA", n:"Tanzania", c:"Dodoma", lat: -6.36, lng: 34.88 },
            { id: 'uy', t:3, iso:"URY", n:"Uruguay", c:"Montevideo", lat: -32.52, lng: -55.76 },
            { id: 'py', t:3, iso:"PRY", n:"Paraguay", c:"Asuncion", lat: -23.44, lng: -58.44 },
            { id: 'ec', t:3, iso:"ECU", n:"Ecuador", c:"Quito", lat: -1.83, lng: -78.18 },
            { id: 'cu', t:3, iso:"CUB", n:"Cuba", c: "Havana", lat: 21.52, lng: -77.78 },
            { id: 'pa', t:3, iso:"PAN", n:"Panama", c:"Panama-Stad", lat: 8.53, lng: -80.78 },
            { id: 'cr', t:3, iso:"CRI", n:"Costa Rica", c:"San Jose", lat: 9.74, lng: -83.75 },
            { id: 'pg', t:3, iso:"PNG", n:"Papoea-Nieuw-Guinea", c:"Port Moresby", lat: -6.31, lng: 143.95 },
            { id: 'uz', t:3, iso:"UZB", n:"Oezbekistan", c:"Tasjkent", lat: 41.37, lng: 64.58 },
            { id: 'tm', t:3, iso:"TKM", n:"Turkmenistan", c:"Asjchabad", lat: 38.96, lng: 59.55 },
            { id: 'kg', t:3, iso:"KGZ", n:"Kirgizi√´", c:"Bisjkek", lat: 41.20, lng: 74.76 },
            { id: 'tj', t:3, iso:"TJK", n:"Tadzjikistan", c:"Doesjanbe", lat: 38.86, lng: 71.27 },
            { id: 'af', t:3, iso:"AFG", n:"Afghanistan", c:"Kaboel", lat: 33.93, lng: 67.71 },
            { id: 'ge', t:3, iso:"GEO", n:"Georgi√´", c:"Tbilisi", lat: 42.31, lng: 43.35 },
            { id: 'am', t:3, iso:"ARM", n:"Armeni√´", c:"Jerevan", lat: 40.06, lng: 45.03 },
            { id: 'az', t:3, iso:"AZE", n:"Azerbeidzjan", c:"Bakoe", lat: 40.14, lng: 47.57 },
            { id: 'jo', t:3, iso:"JOR", n:"Jordani√´", c:"Amman", lat: 30.58, lng: 36.23 },
            { id: 'lb', t:3, iso:"LBN", n:"Libanon", c:"Beiroet", lat: 33.85, lng: 35.86 },
            { id: 'om', t:3, iso:"OMN", n:"Oman", c:"Muscat", lat: 21.47, lng: 55.97 },
            { id: 'ye', t:3, iso:"YEM", n:"Jemen", c:"Sanaa", lat: 15.55, lng: 48.51 },
            { id: 'kh', t:3, iso:"KHM", n:"Cambodja", c:"Phnom Penh", lat: 12.56, lng: 104.99 },
            { id: 'la', t:3, iso:"LAO", n:"Laos", c:"Vientiane", lat: 19.85, lng: 102.49 },
            { id: 'mm', t:3, iso:"MMR", n:"Myanmar", c:"Naypyidaw", lat: 21.91, lng: 95.95 },
            { id: 'bt', t:3, iso:"BTN", n:"Bhutan", c:"Thimphu", lat: 27.51, lng: 90.43 },
            { id: 'sn', t:3, iso:"SEN", n:"Senegal", c:"Dakar", lat: 14.49, lng: -14.45 },
            { id: 'ml', t:3, iso:"MLI", n:"Mali", c:"Bamako", lat: 17.57, lng: -3.99 },
            { id: 'ci', t:3, iso:"CIV", n:"Ivoorkust", c:"Yamoussoukro", lat: 7.54, lng: -5.54 },
            { id: 'cm', t:3, iso:"CMR", n:"Kameroen", c:"Yaound√©", lat: 7.36, lng: 12.35 },
            { id: 'ao', t:3, iso:"AGO", n:"Angola", c:"Luanda", lat: -11.20, lng: 17.87 },
            { id: 'zm', t:3, iso:"ZMB", n:"Zambia", c:"Lusaka", lat: -13.13, lng: 27.84 },
            { id: 'zw', t:3, iso:"ZWE", n:"Zimbabwe", c:"Harare", lat: -19.01, lng: 29.15 },
            { id: 'mz', t:3, iso:"MOZ", n:"Mozambique", c:"Maputo", lat: -18.66, lng: 35.52 },
            { id: 'bw', t:3, iso:"BWA", n:"Botswana", c:"Gaborone", lat: -22.32, lng: 24.68 },
            { id: 'na', t:3, iso:"NAM", n:"Namibi√´", c:"Windhoek", lat: -22.95, lng: 18.49 },
            { id: 'gt', t:3, iso:"GTM", n:"Guatemala", c:"Guatemala-Stad", lat: 15.78, lng: -90.23 },
            { id: 'hn', t:3, iso:"HND", n:"Honduras", c:"Tegucigalpa", lat: 15.20, lng: -86.24 },
            { id: 'ni', t:3, iso:"NIC", n:"Nicaragua", c:"Managua", lat: 12.86, lng: -85.20 },
            { id: 'do', t:3, iso:"DOM", n:"Dominicaanse Republiek", c:"Santo Domingo", lat: 18.73, lng: -70.16 },
            { id: 'ht', t:3, iso:"HTI", n:"Ha√Øti", c:"Port-au-Prince", lat: 18.97, lng: -72.28 },
            { id: 'gy', t:3, iso:"GUY", n:"Guyana", c:"Georgetown", lat: 4.86, lng: -58.93 },
            { id: 'sr', t:3, iso:"SUR", n:"Suriname", c:"Paramaribo", lat: 3.91, lng: -56.02 }
        ];

        let world, queue = [], currentTarget = null, score = 0, round = 0, correctCount = 0, currentStreak = 0;
        let gameMode = 'classic', currentDifficulty = 'easy', countryStatus = {};
        let dragStartX = 0, dragStartY = 0;
        const TOTAL_ROUNDS = 10;

        // --- INIT & SETUP ---
        window.onload = function() {
            initGlobe();
            setupUI();
            
            // Wacht 1.5s op Firebase, anders forceer lokale render
            setTimeout(() => {
                if(!window.firebaseAvailable) {
                    window.renderLeaderboardLocal();
                }
            }, 1500);
        };

        function setupUI() {
            document.getElementById('btnClassic').onclick = () => chooseMode('classic');
            document.getElementById('btnFlags').onclick = () => chooseMode('flags');
            document.getElementById('btnCapitals').onclick = () => chooseMode('capitals');
            document.getElementById('btnEasy').onclick = () => startGame('easy');
            document.getElementById('btnMedium').onclick = () => startGame('medium');
            document.getElementById('btnHard').onclick = () => startGame('hard');
            document.getElementById('btnExam').onclick = () => startGame('exam');
            document.getElementById('btnBack').onclick = resetToModeSelect;
            document.getElementById('nextBtn').onclick = nextRound;
            document.getElementById('restartBtn').onclick = fullReset;
            document.getElementById('btnSaveScore').onclick = handleSaveScore;
        }

        // --- 3D GLOBE ---
        function initGlobe() {
            const container = document.getElementById('globeViz');
            if (typeof Globe === 'undefined') { document.getElementById('loadingMsg').innerText = "‚ö†Ô∏è 3D Start niet. Check verbinding."; return; }

            container.addEventListener('pointerdown', (e) => { dragStartX = e.clientX; dragStartY = e.clientY; });

            world = Globe()
                .width(window.innerWidth).height(window.innerHeight)
                .backgroundColor('#000011')
                .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
                .pointOfView({ lat: 20, lng: 0, altitude: 2.5 })
                .polygonLabel(() => "") 
                .polygonCapColor(d => getCountryColor(d))
                .polygonSideColor(() => 'rgba(0, 50, 80, 0.3)')
                .polygonStrokeColor(() => '#5599ff')
                .onPolygonHover(hoverD => {
                    world.polygonAltitude(d => d === hoverD ? 0.04 : 0.01);
                    world.polygonCapColor(d => getCountryColor(d, hoverD));
                })
                .onPolygonClick(handleCountryClick)(container);

            window.addEventListener('resize', () => { world.width(window.innerWidth); world.height(window.innerHeight); });

            fetch('https://raw.githubusercontent.com/vasturiano/globe.gl/master/example/datasets/ne_110m_admin_0_countries.geojson')
                .then(res => res.json()).then(countries => {
                    world.polygonsData(countries.features);
                    document.getElementById('loadingMsg').style.display = 'none';
                    world.controls().autoRotate = true; world.controls().autoRotateSpeed = 0.5;
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loadingMsg').innerText = "‚ö†Ô∏è Data laad fout";
                });
        }

        function getCountryColor(d, hoverD = null) {
            const status = countryStatus[d.properties.ADM0_A3] || countryStatus[d.properties.ISO_A3];
            if (status === 'correct') return '#22c55e'; 
            if (status === 'wrong') return '#ef4444'; 
            if (status === 'target') return '#22c55e'; 
            if (d === hoverD) return 'rgba(255, 255, 255, 0.2)';
            return 'rgba(200, 250, 255, 0.1)'; 
        }

        // --- GAME LOGIC ---
        function chooseMode(mode) { gameMode = mode; document.getElementById('modeSelection').classList.add('hidden'); document.getElementById('difficultySelection').classList.remove('hidden'); }
        function resetToModeSelect() { document.getElementById('modeSelection').classList.remove('hidden'); document.getElementById('difficultySelection').classList.add('hidden'); }

        // FISHER-YATES SHUFFLE
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame(difficulty) {
            currentDifficulty = difficulty;
            document.getElementById('startScreen').style.opacity = '0';
            setTimeout(() => document.getElementById('startScreen').classList.add('hidden'), 500);

            let pool = (difficulty === 'easy') ? COUNTRIES.filter(c => c.t === 1) : 
                       (difficulty === 'medium') ? COUNTRIES.filter(c => c.t === 2) : 
                       (difficulty === 'hard') ? COUNTRIES.filter(c => c.t === 3) : COUNTRIES;
            
            queue = shuffleArray([...pool]).slice(0, TOTAL_ROUNDS);
            
            score = 0; round = 0; correctCount = 0; currentStreak = 0;
            updateScore(0); updateStreakUI(); initAudio(); nextRound();
        }

        function nextRound() {
            document.getElementById('resultBar').classList.add('hidden');
            document.getElementById('questionCard').classList.remove('hidden');
            countryStatus = {};
            if(world) { world.polygonCapColor(d => getCountryColor(d)); world.controls().autoRotate = true; }
            if (round >= TOTAL_ROUNDS) { showEndScreen(); return; }
            round++;
            document.getElementById('roundDisplay').innerText = round;
            currentTarget = queue.shift();
            updateQuestionUI();
        }

        function updateQuestionUI() {
            const els = { flag: document.getElementById('targetFlag'), name: document.getElementById('targetName'), capital: document.getElementById('targetCapital'), flagCont: document.getElementById('flagContainer'), instr: document.getElementById('instructionLabel'), capWrap: document.getElementById('capitalWrapper') };
            
            // GEBRUIK IMG TAG VOOR VLAG
            els.flag.innerHTML = `<img src="https://flagcdn.com/w160/${currentTarget.id}.png" class="w-full h-full object-contain" alt="${currentTarget.n}">`;
            
            els.name.innerText = currentTarget.n; 
            els.capital.innerText = currentTarget.c;
            
            els.flagCont.style.display = 'flex'; els.name.style.display = 'block'; els.capWrap.style.display = 'block';
            els.name.className = "text-2xl font-black text-gray-800 leading-none mb-1 truncate"; els.capital.className = "text-blue-700 text-sm font-bold truncate";
            
            if (gameMode === 'classic') els.instr.innerText = "Zoek dit land:";
            else if (gameMode === 'flags') { els.instr.innerText = "Welk land is dit?"; els.name.style.display = 'none'; els.capWrap.style.display = 'none'; }
            else if (gameMode === 'capitals') { els.instr.innerText = "Waar ligt deze stad?"; els.flagCont.style.display = 'none'; els.name.style.display = 'none'; els.capital.className = "text-3xl font-black text-blue-700 block mt-2 truncate"; }
        }

        function handleCountryClick(polygon, event) {
            if (!document.getElementById('resultBar').classList.contains('hidden')) return;
            if (event) { const dist = Math.sqrt(Math.pow(event.clientX - dragStartX, 2) + Math.pow(event.clientY - dragStartY, 2)); if (dist > 10) return; }

            world.controls().autoRotate = false;
            const clickedIso = polygon.properties.ADM0_A3 || polygon.properties.ISO_A3;
            const clickedName = polygon.properties.ADMIN || polygon.properties.NAME;
            const isCorrect = clickedIso === currentTarget.iso;

            if (isCorrect) {
                countryStatus[clickedIso] = 'correct';
                playSound('success'); fireConfetti(); correctCount++; currentStreak++;
                let points = (currentDifficulty === 'easy') ? 10 : (currentDifficulty === 'medium') ? 12 : 15;
                if (currentStreak >= 3) { points += 5; playSound('bonus'); } 
                score += points;
                updateScore(0); updateStreakUI(); showResult(true, currentTarget.n);
            } else {
                playSound('wrong'); currentStreak = 0; updateStreakUI();
                countryStatus[clickedIso] = 'wrong'; countryStatus[currentTarget.iso] = 'target';
                const clickedCountryData = COUNTRIES.find(c => c.iso === clickedIso);
                const displayWrongName = clickedCountryData ? clickedCountryData.n : clickedName;
                showResult(false, displayWrongName);
                if (currentTarget.lat && currentTarget.lng) world.pointOfView({ lat: currentTarget.lat, lng: currentTarget.lng, altitude: 2.0 }, 1500);
            }
            world.polygonCapColor(d => getCountryColor(d));
        }

        function updateStreakUI() {
            const el = document.getElementById('streakBadge');
            const cnt = document.getElementById('streakCount');
            if (currentStreak >= 3) { el.classList.remove('hidden'); el.classList.add('flex'); cnt.innerText = currentStreak; }
            else { el.classList.add('hidden'); el.classList.remove('flex'); }
        }

        function showResult(isCorrect, textData) {
            document.getElementById('questionCard').classList.add('hidden');
            const bar = document.getElementById('resultBar');
            bar.classList.remove('hidden');
            const title = document.getElementById('resultTitle'); const sub = document.getElementById('resultSub'); const content = document.getElementById('resultContent');
            if (isCorrect) {
                content.className = "bg-green-100 text-green-900 rounded-3xl shadow-2xl p-4 border-b-8 border-green-400 flex items-center justify-between gap-4";
                title.innerText = "Goed zo! üéâ"; sub.innerText = `${currentTarget.n} gevonden!`;
                if(currentStreak >= 3) sub.innerText += ` (+5 streak bonus!)`;
            } else {
                content.className = "bg-red-100 text-red-900 rounded-3xl shadow-2xl p-4 border-b-8 border-red-300 flex items-center justify-between gap-4";
                title.innerText = "Helaas..."; sub.innerHTML = `Je klikte op <strong>${textData}</strong>.<br>Groen is ${currentTarget.n}.`;
            }
        }

        function updateScore(points) { document.getElementById('scoreDisplay').innerText = score; }

        function showEndScreen() {
            document.getElementById('questionCard').classList.add('hidden');
            document.getElementById('endScreen').classList.remove('hidden');
            if (correctCount === 10) { score += 50; updateScore(0); playSound('win'); fireConfetti(); }
            else if (correctCount > 7) { playSound('win'); fireConfetti(); }
            document.getElementById('finalScore').innerText = score;
            document.getElementById('finalCorrectCount').innerText = `${correctCount} / 10`;
            checkHighScore(score);
        }

        // --- SCORES & LEADERBOARD ---
        window.updateLeaderboardUI = function(scores, isOnline) {
            const list = document.getElementById('leaderboardList');
            const badge = document.getElementById('scoreSourceBadge');
            badge.innerText = isOnline ? "Online" : "Lokaal";
            badge.className = isOnline ? "text-[10px] bg-green-500/20 text-green-400 px-2 py-0.5 rounded" : "text-[10px] bg-white/10 px-2 py-0.5 rounded text-gray-400";
            if (scores.length === 0) { list.innerHTML = '<div class="text-center text-gray-500 text-xs py-4">Nog geen scores...</div>'; return; }
            list.innerHTML = scores.map((s, i) => `
                <div class="flex justify-between items-center bg-white/10 px-3 py-2 rounded-lg border border-white/5">
                    <div class="flex gap-3 items-center"><span class="text-yellow-500 font-black w-4 text-xs">${i+1}.</span><span class="font-bold text-white text-xs truncate max-w-[100px]">${s.name}</span></div><span class="text-yellow-400 font-mono text-xs font-bold">${s.score}</span>
                </div>
            `).join('');
        };

        window.renderLeaderboardLocal = function() {
            let scores = JSON.parse(localStorage.getItem('wr3d_scores'));
            if (!scores || scores.length === 0) {
                scores = [
                    { name: "Wereldreiziger", score: 100 },
                    { name: "Piraat", score: 80 },
                    { name: "Piloot", score: 50 }
                ];
                localStorage.setItem('wr3d_scores', JSON.stringify(scores));
            }
            window.updateLeaderboardUI(scores, false);
        }

        function checkHighScore(finalScore) {
            const scores = window.firebaseAvailable ? [] : (JSON.parse(localStorage.getItem('wr3d_scores')) || []);
            document.getElementById('highScoreInputArea').classList.remove('hidden');
            document.getElementById('restartBtn').classList.add('hidden');
        }

        function handleSaveScore() {
            const name = document.getElementById('playerNameInput').value.trim() || "Anoniem";
            if (window.firebaseAvailable && window.saveScoreCloud) {
                window.saveScoreCloud(name, score);
            } else {
                const scores = JSON.parse(localStorage.getItem('wr3d_scores')) || [];
                scores.push({ name, score });
                scores.sort((a, b) => b.score - a.score);
                localStorage.setItem('wr3d_scores', JSON.stringify(scores.slice(0, 10)));
                window.renderLeaderboardLocal();
            }
            document.getElementById('highScoreInputArea').classList.add('hidden');
            document.getElementById('restartBtn').classList.remove('hidden');
        }

        function fullReset() {
            // HANDMATIGE RESET I.P.V RELOAD
            document.getElementById('endScreen').classList.add('hidden');
            const startScreen = document.getElementById('startScreen');
            startScreen.classList.remove('hidden');
            requestAnimationFrame(() => { startScreen.style.opacity = '1'; });

            // Reset state
            score = 0; round = 0; correctCount = 0; currentStreak = 0; queue = []; currentTarget = null; countryStatus = {};

            // Reset UI
            document.getElementById('scoreDisplay').innerText = "0";
            document.getElementById('roundDisplay').innerText = "1 / 10";
            document.getElementById('streakBadge').classList.add('hidden');
            document.getElementById('streakBadge').classList.remove('flex');

            // Reset Globe
            if (world) {
                world.polygonCapColor(d => getCountryColor(d)); 
                world.controls().autoRotate = true;
                world.pointOfView({ lat: 20, lng: 0, altitude: 2.5 }, 1000);
            }

            resetToModeSelect();
            if(!window.firebaseAvailable) window.renderLeaderboardLocal();
        }

        function fireConfetti() { confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } }); }
        let audioCtx; function initAudio() { if (!audioCtx) { const AC = window.AudioContext || window.webkitAudioContext; if (AC) audioCtx = new AC(); } }
        function playSound(type) {
            if (!audioCtx) return; const t = audioCtx.currentTime; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
            if (type === 'success') { o.frequency.setValueAtTime(500, t); o.frequency.exponentialRampToValueAtTime(1000, t + 0.1); g.gain.setValueAtTime(0.3, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.5); o.start(t); o.stop(t+0.5); }
            else if (type === 'wrong') { o.type='triangle'; o.frequency.setValueAtTime(150, t); g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0.01, t+0.3); o.start(t); o.stop(t+0.3); }
            else if (type === 'bonus') { o.type='sine'; o.frequency.setValueAtTime(800, t); o.frequency.exponentialRampToValueAtTime(1200, t+0.1); g.gain.setValueAtTime(0.3, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.3); o.start(t); o.stop(t+0.3); }
            else if (type === 'win') { [523, 659, 783, 1046].forEach((f, i) => { const osc=audioCtx.createOscillator(); const gn=audioCtx.createGain(); osc.connect(gn); gn.connect(audioCtx.destination); osc.frequency.value=f; gn.gain.setValueAtTime(0.1, t+i*0.1); gn.gain.exponentialRampToValueAtTime(0.01, t+i*0.1+0.3); osc.start(t+i*0.1); osc.stop(t+i*0.1+0.3); }); }
        }
    </script>
</body>
</html>